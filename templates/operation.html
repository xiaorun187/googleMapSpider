<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps å•†å®¶æ•°æ®æå–</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; padding: 10px; overflow: hidden; }
        .container { max-width: 1800px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 8px 20px; background: rgba(255,255,255,0.98); border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); margin-bottom: 10px; flex-shrink: 0; }
        .header h1 { font-size: 18px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 8px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .nav-links { display: flex; gap: 8px; }
        .nav-links a { padding: 8px 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 8px; font-size: 12px; font-weight: 500; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 10px; flex: 1; min-height: 0; }
        .control-panel { background: rgba(255,255,255,0.98); border-radius: 10px; padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); overflow-y: auto; }
        .data-panel { background: rgba(255,255,255,0.98); border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-height: 0; }
        .panel-title { font-size: 14px; font-weight: 600; color: #1a1a2e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .panel-title::before { content: ""; width: 3px; height: 16px; background: linear-gradient(180deg, #667eea, #764ba2); border-radius: 2px; }
    </style>
    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
</head>
<body>
<div class="container">
    <header class="header">
        <h1><span class="logo-icon">ğŸ—ºï¸</span>Google Maps å•†å®¶æ•°æ®æå–</h1>
        <nav class="nav-links"><a href="/history">ğŸ“‹ å†å²</a><a href="/send_email_page">âœ‰ï¸ é‚®ä»¶</a></nav>
    </header>

    <div class="main-content">
        <aside class="control-panel" id="control-panel"></aside>
        <main class="data-panel" id="data-panel"></main>
    </div>
</div>
</body>
</html>

<style>
    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; font-size: 11px; font-weight: 600; color: #4a5568; margin-bottom: 4px; }
    .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: #f8fafc; }
    .form-group input:focus { outline: none; border-color: #667eea; background: white; }
    .form-select { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: #f8fafc; cursor: pointer; }
    .form-select:focus { outline: none; border-color: #667eea; }
    .form-select:disabled { background-color: #f1f5f9; cursor: not-allowed; opacity: 0.7; }
    .checkbox-group { display: flex; align-items: center; gap: 6px; padding: 8px 10px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; }
    .checkbox-group input { width: 14px; height: 14px; accent-color: #667eea; }
    .checkbox-group label { font-size: 12px; }
    .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .progress-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f5f9; }
    .progress-label { font-size: 10px; font-weight: 600; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
    .progress-bar-container { background: #e2e8f0; border-radius: 6px; height: 8px; overflow: hidden; margin-bottom: 6px; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 6px; transition: width 0.3s; }
    .progress-text { font-size: 11px; color: #64748b; display: flex; align-items: center; gap: 6px; }
    .spinner { width: 12px; height: 12px; border: 2px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .data-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; border-radius: 10px 10px 0 0; flex-shrink: 0; }
    .data-header h2 { font-size: 13px; font-weight: 600; color: #1a1a2e; }
    .data-stats { display: flex; gap: 14px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 15px; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; }
    .toolbar { display: flex; gap: 8px; padding: 6px 14px; background: #fafbfc; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
    .search-box { flex: 1; position: relative; }
    .search-box input { width: 100%; padding: 5px 10px 5px 28px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 12px; }
    .search-box::before { content: "ğŸ”"; position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; }
    .view-toggle { display: flex; background: #e2e8f0; border-radius: 5px; padding: 2px; }
    .view-toggle button { padding: 3px 10px; border: none; background: transparent; border-radius: 3px; cursor: pointer; font-size: 11px; }
    .view-toggle button.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .data-list { padding: 12px; flex: 1; min-height: 0; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(5, 1fr); gap: 10px; overflow: auto; }
    .data-list.data-list-table { display: block; padding: 0; }
    .business-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 14px; display: flex; flex-direction: column; justify-content: space-between; min-height: 0; overflow: hidden; }
    .business-card:hover { border-color: #667eea; box-shadow: 0 2px 6px rgba(102,126,234,0.12); }
    .business-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-shrink: 0; }
    .business-name { font-size: 13px; font-weight: 600; color: #1a1a2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .business-index { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: 8px; flex-shrink: 0; }
    .business-info { display: flex; gap: 10px; flex-wrap: wrap; flex: 1; align-content: center; }
</style>

<style>
    .info-item { display: flex; align-items: center; gap: 6px; }
    .info-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; background: #f0f4ff; border-radius: 4px; font-size: 11px; flex-shrink: 0; }
    .info-content { flex: 1; min-width: 0; }
    .info-label { display: none; }
    .info-value { font-size: 12px; color: #334155; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .info-value a { color: #667eea; text-decoration: none; }
    .info-value.empty { color: #cbd5e1; font-style: italic; }
    .social-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e2e8f0; flex-shrink: 0; }
    .social-tag { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 8px; font-size: 9px; font-weight: 500; text-decoration: none; }
    .social-tag.facebook { background: #e7f3ff; color: #1877f2; }
    .social-tag.twitter { background: #e8f5fd; color: #1da1f2; }
    .social-tag.instagram { background: #fce4ec; color: #e4405f; }
    .social-tag.linkedin { background: #e8f4f8; color: #0077b5; }
    .social-tag.youtube { background: #ffebee; color: #ff0000; }
    .social-tag.whatsapp { background: #e8f5e9; color: #25d366; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 16px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 1; }
    .data-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .data-table tr:hover td { background: #f8fafc; }
    .data-table a { color: #667eea; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 3px; padding: 6px 14px; border-top: 1px solid #e2e8f0; flex-shrink: 0; }
    .pagination button { padding: 3px 8px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .pagination button:hover:not(:disabled) { border-color: #667eea; color: #667eea; }
    .pagination button.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: transparent; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-info { font-size: 11px; color: #64748b; margin: 0 6px; }
    .download-section { padding: 6px 14px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-top: 1px solid #d1fae5; display: none; justify-content: space-between; align-items: center; border-radius: 0 0 10px 10px; flex-shrink: 0; }
    .download-section.show { display: flex; }
    .download-btn { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; text-decoration: none; border-radius: 5px; font-weight: 600; font-size: 11px; }
    .empty-state { text-align: center; padding: 30px 16px; color: #94a3b8; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .empty-icon { font-size: 32px; margin-bottom: 8px; }
    @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } .business-info { grid-template-columns: 1fr 1fr; } }
    

</style>

<script>
document.getElementById('control-panel').innerHTML = `
    <h3 class="panel-title">æå–è®¾ç½®</h3>
    <form id="extraction-form">
        <div class="form-group">
            <label>ğŸŒ å›½å®¶</label>
            <select id="country" name="country" class="form-select"><option value="">-- é€‰æ‹©å›½å®¶ --</option></select>
        </div>
        <div class="form-group">
            <label>ğŸ™ï¸ åŸå¸‚ <span style="font-weight:normal;color:#94a3b8;font-size:10px;">(å¯é€‰)</span></label>
            <select id="city-select" name="city-select" class="form-select" disabled><option value="">-- å…ˆé€‰æ‹©å›½å®¶ --</option></select>
            <input type="text" id="city" name="city" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥åŸå¸‚..." style="margin-top: 4px;">
            <div id="country-scrape-hint" style="display:none;margin-top:4px;padding:6px 8px;background:#fef3c7;border-radius:4px;font-size:11px;color:#92400e;">
                ğŸ’¡ æœªé€‰æ‹©åŸå¸‚ï¼Œå°†æŒ‰é¡ºåºçˆ¬å–æ•´ä¸ªå›½å®¶çš„æ‰€æœ‰åŸå¸‚
            </div>
        </div>
        <div class="form-group"><label>ğŸ›ï¸ å•†å“/æœåŠ¡</label><input type="text" id="product" name="product" placeholder="ä¾‹å¦‚: sofa, restaurant..." required></div>
        <input type="hidden" id="url" name="url">
        <div class="form-group"><label>æ•°é‡ <span style="font-weight:normal;color:#94a3b8;font-size:10px;">(ç•™ç©º=ä¸é™åˆ¶)</span></label><input type="number" id="limit" name="limit" placeholder="ç•™ç©ºä¸é™åˆ¶" min="1"></div>
        <div class="form-group"><label>ä»£ç† (å¯é€‰)</label><input type="text" id="proxy" name="proxy" placeholder="user:pass@host:port"></div>
        <div class="form-group"><div class="checkbox-group"><input type="checkbox" id="remember_position"><label for="remember_position">è®°ä½ä½ç½®</label></div></div>
        <button type="submit" class="btn btn-primary" id="start-btn">ğŸš€ å¼€å§‹æå–</button>
        <button type="button" class="btn" id="stop-btn" style="display:none; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">â¹ï¸ åœæ­¢æå–</button>
        <button type="button" class="btn btn-success" id="extract-contacts-btn" style="display:none;">ğŸ“§ æå–è”ç³»æ–¹å¼</button>
        <button type="button" class="btn btn-warning" id="send-email-btn">âœ‰ï¸ æ‰¹é‡å‘é‚®ä»¶</button>
    </form>
    <div class="progress-section">
        <div class="progress-label">è¿›åº¦</div>
        <div class="progress-bar-container"><div class="progress-bar" id="progress-bar" style="width:0%"></div></div>
        <p class="progress-text" id="progress-text">ç­‰å¾…å¼€å§‹...</p>
    </div>
`;

document.getElementById('data-panel').innerHTML = `
    <div class="data-header">
        <h2>ğŸ“Š æå–ç»“æœ</h2>
        <div class="data-stats">
            <div class="stat-item"><div class="stat-value" id="total-count">0</div><div class="stat-label">æ€»æ•°</div></div>
            <div class="stat-item"><div class="stat-value" id="email-count">0</div><div class="stat-label">é‚®ç®±</div></div>
            <div class="stat-item"><div class="stat-value" id="website-count">0</div><div class="stat-label">ç½‘ç«™</div></div>
        </div>
    </div>
    <div class="toolbar">
        <div class="search-box"><input type="text" id="search-input" placeholder="æœç´¢..."></div>
        <div class="view-toggle"><button class="active" data-view="card">å¡ç‰‡</button><button data-view="table">è¡¨æ ¼</button></div>
    </div>
    <div class="data-list" id="data-list"></div>
    <div class="pagination" id="pagination"></div>
    <div class="download-section" id="download-section">
        <span>âœ… å®Œæˆ</span>
        <a href="#" class="download-btn" id="download-btn">ğŸ“¥ ä¸‹è½½</a>
    </div>
`;
</script>

<script>
const socket = io();
let businessData = [], currentView = 'card', searchQuery = '', currentPage = 1, pageSize = 10;
let countryCityData = {};

// æ•°æ®æŒä¹…åŒ–åŠŸèƒ½
const STORAGE_KEY = 'gmaps_business_data';
const DOWNLOAD_KEY = 'gmaps_download_file';
const FORM_STATE_KEY = 'gmaps_form_state';

function saveDataToStorage() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(businessData));
    } catch (e) { console.warn('ä¿å­˜æ•°æ®å¤±è´¥:', e); }
}

function loadDataFromStorage() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            businessData = JSON.parse(saved);
            renderData();
            // æ¢å¤ä¸‹è½½æŒ‰é’®
            const downloadFile = localStorage.getItem(DOWNLOAD_KEY);
            if (downloadFile && businessData.length > 0) {
                document.getElementById('download-btn').href = `/download/${downloadFile}`;
                document.getElementById('download-section').classList.add('show');
                document.getElementById('extract-contacts-btn').style.display = 'block';
            }
        }
    } catch (e) { console.warn('åŠ è½½æ•°æ®å¤±è´¥:', e); }
}

function clearStoredData() {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(DOWNLOAD_KEY);
}

// è¡¨å•çŠ¶æ€æŒä¹…åŒ–
function saveFormState() {
    try {
        const formState = {
            country: document.getElementById('country').value,
            citySelect: document.getElementById('city-select').value,
            city: document.getElementById('city').value,
            product: document.getElementById('product').value,
            limit: document.getElementById('limit').value,
            proxy: document.getElementById('proxy').value,
            rememberPosition: document.getElementById('remember_position').checked
        };
        localStorage.setItem(FORM_STATE_KEY, JSON.stringify(formState));
    } catch (e) { console.warn('ä¿å­˜è¡¨å•çŠ¶æ€å¤±è´¥:', e); }
}

function loadFormState() {
    try {
        const saved = localStorage.getItem(FORM_STATE_KEY);
        if (saved) {
            const formState = JSON.parse(saved);
            
            // æ¢å¤å›½å®¶é€‰æ‹©
            if (formState.country) {
                document.getElementById('country').value = formState.country;
                populateCitySelect(formState.country);
                
                // æ¢å¤åŸå¸‚ä¸‹æ‹‰é€‰æ‹©
                if (formState.citySelect) {
                    document.getElementById('city-select').value = formState.citySelect;
                }
            }
            
            // æ¢å¤å…¶ä»–å­—æ®µ
            if (formState.city) document.getElementById('city').value = formState.city;
            if (formState.product) document.getElementById('product').value = formState.product;
            if (formState.limit) document.getElementById('limit').value = formState.limit;
            if (formState.proxy) document.getElementById('proxy').value = formState.proxy;
            if (formState.rememberPosition !== undefined) {
                document.getElementById('remember_position').checked = formState.rememberPosition;
            }
            
            // æ›´æ–°å›½å®¶çˆ¬å–æç¤º
            updateCountryScrapeHint();
        }
    } catch (e) { console.warn('åŠ è½½è¡¨å•çŠ¶æ€å¤±è´¥:', e); }
}

// ç›‘å¬è¡¨å•å˜åŒ–è‡ªåŠ¨ä¿å­˜
function setupFormAutoSave() {
    const formElements = ['country', 'city-select', 'city', 'product', 'limit', 'proxy', 'remember_position'];
    formElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', saveFormState);
            if (el.type === 'text' || el.type === 'number') {
                el.addEventListener('input', saveFormState);
            }
        }
    });
}

async function loadCountryCityData() {
    try {
        const response = await fetch('/api/countries');
        if (response.ok) { countryCityData = await response.json(); populateCountrySelect(); }
        else { loadLocalCountryCityData(); }
    } catch (e) { loadLocalCountryCityData(); }
    
    // å›½å®¶æ•°æ®åŠ è½½å®Œæˆåæ¢å¤è¡¨å•çŠ¶æ€
    loadFormState();
    setupFormAutoSave();
}

function loadLocalCountryCityData() {
    countryCityData = {
        "US": { "name": "United States", "cities": ["New York", "Los Angeles", "Chicago", "Houston", "Phoenix", "Seattle", "Denver", "Boston", "Atlanta", "Miami"] },
        "GB": { "name": "United Kingdom", "cities": ["London", "Birmingham", "Manchester", "Glasgow", "Liverpool", "Leeds"] },
        "CA": { "name": "Canada", "cities": ["Toronto", "Montreal", "Vancouver", "Calgary", "Edmonton", "Ottawa"] },
        "AU": { "name": "Australia", "cities": ["Sydney", "Melbourne", "Brisbane", "Perth", "Adelaide"] },
        "DE": { "name": "Germany", "cities": ["Berlin", "Hamburg", "Munich", "Cologne", "Frankfurt"] },
        "FR": { "name": "France", "cities": ["Paris", "Marseille", "Lyon", "Toulouse", "Nice"] },
        "CN": { "name": "China", "cities": ["Shanghai", "Beijing", "Guangzhou", "Shenzhen", "Chengdu", "Hangzhou"] },
        "JP": { "name": "Japan", "cities": ["Tokyo", "Osaka", "Nagoya", "Sapporo", "Fukuoka", "Kyoto"] }
    };
    populateCountrySelect();
}

function populateCountrySelect() {
    const sel = document.getElementById('country');
    sel.innerHTML = '<option value="">-- é€‰æ‹©å›½å®¶ --</option>';
    Object.keys(countryCityData).sort((a, b) => countryCityData[a].name.localeCompare(countryCityData[b].name)).forEach(code => {
        sel.innerHTML += `<option value="${code}">${countryCityData[code].name}</option>`;
    });
}

function populateCitySelect(code) {
    const sel = document.getElementById('city-select');
    if (!code || !countryCityData[code]) { sel.innerHTML = '<option value="">-- å…ˆé€‰æ‹©å›½å®¶ --</option>'; sel.disabled = true; return; }
    sel.innerHTML = '<option value="">-- é€‰æ‹©åŸå¸‚ --</option>';
    (countryCityData[code].cities || []).forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
    sel.disabled = false;
}

document.getElementById('country').addEventListener('change', function() { 
    populateCitySelect(this.value); 
    document.getElementById('city').value = ''; 
    updateCountryScrapeHint();
});
document.getElementById('city-select').addEventListener('change', function() { 
    document.getElementById('city').value = this.value; 
    updateCountryScrapeHint();
});
document.getElementById('city').addEventListener('input', function() {
    updateCountryScrapeHint();
});

function updateCountryScrapeHint() {
    const country = document.getElementById('country').value;
    const city = document.getElementById('city').value.trim();
    const citySelect = document.getElementById('city-select').value;
    const hint = document.getElementById('country-scrape-hint');
    
    // å¦‚æœé€‰äº†å›½å®¶ä½†æ²¡æœ‰åŸå¸‚ï¼Œæ˜¾ç¤ºæç¤º
    if (country && !city && !citySelect) {
        const countryName = countryCityData[country]?.name || country;
        const cityCount = countryCityData[country]?.cities?.length || 0;
        hint.innerHTML = `ğŸ’¡ æœªé€‰æ‹©åŸå¸‚ï¼Œå°†æŒ‰é¡ºåºçˆ¬å– <strong>${countryName}</strong> çš„ ${cityCount} ä¸ªåŸå¸‚`;
        hint.style.display = 'block';
    } else {
        hint.style.display = 'none';
    }
}

loadCountryCityData();

function updateStats() {
    document.getElementById('total-count').textContent = businessData.length;
    document.getElementById('email-count').textContent = businessData.filter(b => b.emails && b.emails.length > 0).length;
    document.getElementById('website-count').textContent = businessData.filter(b => b.website).length;
}

function formatValue(v) {
    if (!v || (Array.isArray(v) && !v.length)) return '<span class="empty">-</span>';
    if (Array.isArray(v)) return v.map(x => x && x.includes && x.includes('http') ? `<a href="${x}" target="_blank">${x}</a>` : x).join(', ');
    if (v.includes && v.includes('http')) { const s = v.length > 30 ? v.slice(0,30)+'...' : v; return `<a href="${v}" target="_blank" title="${v}">${s}</a>`; }
    return v;
}
</script>

<script>
function renderCard(b, i) {
    const tags = [];
    if (b.facebook) tags.push(`<a href="${b.facebook}" target="_blank" class="social-tag facebook">FB</a>`);
    if (b.twitter) tags.push(`<a href="${b.twitter}" target="_blank" class="social-tag twitter">TW</a>`);
    if (b.instagram) tags.push(`<a href="${b.instagram}" target="_blank" class="social-tag instagram">IG</a>`);
    if (b.linkedin) tags.push(`<a href="${b.linkedin}" target="_blank" class="social-tag linkedin">LI</a>`);
    if (b.youtube) tags.push(`<a href="${b.youtube}" target="_blank" class="social-tag youtube">YT</a>`);
    if (b.whatsapp) tags.push(`<a href="${b.whatsapp}" target="_blank" class="social-tag whatsapp">WA</a>`);
    return `<div class="business-card"><div class="business-card-header"><span class="business-name">${b.name||'Unknown'}</span><span class="business-index">#${i+1}</span></div>
        <div class="business-info">
            <div class="info-item"><span class="info-icon">ğŸŒ</span><div class="info-content"><div class="info-label">ç½‘ç«™</div><div class="info-value">${formatValue(b.website)}</div></div></div>
            <div class="info-item"><span class="info-icon">ğŸ“§</span><div class="info-content"><div class="info-label">é‚®ç®±</div><div class="info-value">${formatValue(b.emails)}</div></div></div>
            <div class="info-item"><span class="info-icon">ğŸ“</span><div class="info-content"><div class="info-label">ç”µè¯</div><div class="info-value">${formatValue(b.phones)}</div></div></div>
        </div>${tags.length ? `<div class="social-tags">${tags.join('')}</div>` : ''}</div>`;
}

function renderTable(data, startIdx) {
    return `<table class="data-table"><thead><tr><th>#</th><th>åç§°</th><th>ç½‘ç«™</th><th>é‚®ç®±</th><th>ç”µè¯</th></tr></thead>
        <tbody>${data.map((b,i) => `<tr><td>${startIdx+i+1}</td><td>${b.name||'-'}</td><td>${formatValue(b.website)}</td><td>${formatValue(b.emails)}</td><td>${formatValue(b.phones)}</td></tr>`).join('')}</tbody></table>`;
}

function renderPagination(total) {
    const pages = Math.ceil(total / pageSize);
    const pag = document.getElementById('pagination');
    if (pages <= 1) { pag.innerHTML = ''; return; }
    let html = `<button ${currentPage===1?'disabled':''} onclick="goPage(1)">é¦–</button>
        <button ${currentPage===1?'disabled':''} onclick="goPage(${currentPage-1})">â€¹</button>`;
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(pages, currentPage + 2); i++) 
        html += `<button class="${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
    html += `<span class="page-info">${currentPage}/${pages}</span>
        <button ${currentPage===pages?'disabled':''} onclick="goPage(${currentPage+1})">â€º</button>
        <button ${currentPage===pages?'disabled':''} onclick="goPage(${pages})">æœ«</button>`;
    pag.innerHTML = html;
}

window.goPage = function(p) { currentPage = p; renderData(); };

function renderData() {
    let filtered = businessData;
    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = businessData.filter(b => (b.name && b.name.toLowerCase().includes(q)) || (b.website && b.website.toLowerCase().includes(q)) || (b.emails && b.emails.some(e => e.toLowerCase().includes(q))));
    }
    const list = document.getElementById('data-list');
    if (!filtered.length) {
        list.className = 'data-list';
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">${searchQuery?'ğŸ”':'ğŸ“­'}</div><div>${searchQuery?'æœªæ‰¾åˆ°':'æš‚æ— æ•°æ®'}</div></div>`;
        document.getElementById('pagination').innerHTML = '';
    } else {
        const start = (currentPage - 1) * pageSize, pageData = filtered.slice(start, start + pageSize);
        if (currentView === 'card') {
            list.className = 'data-list';
            list.innerHTML = pageData.map((b, i) => renderCard(b, start + i)).join('');
        } else {
            list.className = 'data-list data-list-table';
            list.innerHTML = renderTable(pageData, start);
        }
        renderPagination(filtered.length);
    }
    updateStats();
}
</script>

<script>
let isExtracting = false;

document.getElementById('extraction-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const country = document.getElementById('country').value;
    const city = document.getElementById('city').value.trim();
    const product = document.getElementById('product').value.trim();
    
    // å•†å“å¿…å¡«ï¼ŒåŸå¸‚å¯é€‰ï¼ˆå¦‚æœé€‰äº†å›½å®¶ä½†æ²¡é€‰åŸå¸‚ï¼Œåˆ™çˆ¬å–æ•´ä¸ªå›½å®¶ï¼‰
    if (!product) { alert('è¯·è¾“å…¥å•†å“/æœåŠ¡åç§°'); return; }
    if (!city && !country) { alert('è¯·é€‰æ‹©å›½å®¶æˆ–è¾“å…¥åŸå¸‚åç§°'); return; }
    
    businessData = []; currentPage = 1; clearStoredData(); renderData();
    document.getElementById('download-section').classList.remove('show');
    document.getElementById('extract-contacts-btn').style.display = 'none';
    document.getElementById('start-btn').disabled = true;
    document.getElementById('start-btn').style.display = 'none';
    document.getElementById('stop-btn').style.display = 'flex';
    isExtracting = true;
    document.getElementById('progress-bar').style.width = '0%';
    
    // å¦‚æœæ²¡æœ‰åŸå¸‚ä½†æœ‰å›½å®¶ï¼Œæ˜¾ç¤ºå°†çˆ¬å–æ•´ä¸ªå›½å®¶
    const statusMsg = city ? `å®šä½: ${city}...` : `å‡†å¤‡çˆ¬å– ${countryCityData[country]?.name || country} çš„æ‰€æœ‰åŸå¸‚...`;
    document.getElementById('progress-text').innerHTML = `<span class="spinner"></span> ${statusMsg}`;
    
    fetch('/start_extraction', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `country=${encodeURIComponent(country)}&city=${encodeURIComponent(city)}&product=${encodeURIComponent(product)}&limit=${document.getElementById('limit').value}&proxy=${encodeURIComponent(document.getElementById('proxy').value)}&remember_position=${document.getElementById('remember_position').checked?'on':'off'}`
    }).then(r => r.json()).then(d => { 
        if (d.status !== 'success') { 
            document.getElementById('progress-text').textContent = 'é”™è¯¯: ' + d.message; 
            resetExtractionUI();
        }
    });
});

document.getElementById('stop-btn').addEventListener('click', function() {
    if (!isExtracting) return;
    this.disabled = true;
    this.innerHTML = '<span class="spinner"></span> åœæ­¢ä¸­...';
    document.getElementById('progress-text').innerHTML = '<span class="spinner"></span> æ­£åœ¨åœæ­¢...';
    fetch('/stop_extraction', { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            if (d.status === 'success') {
                document.getElementById('progress-text').textContent = d.message;
            } else {
                document.getElementById('progress-text').textContent = 'åœæ­¢å¤±è´¥: ' + d.message;
            }
        })
        .catch(e => {
            document.getElementById('progress-text').textContent = 'åœæ­¢è¯·æ±‚å¤±è´¥';
        });
});

function resetExtractionUI() {
    isExtracting = false;
    document.getElementById('start-btn').disabled = false;
    document.getElementById('start-btn').style.display = 'flex';
    document.getElementById('start-btn').innerHTML = 'ğŸš€ å¼€å§‹æå–';
    document.getElementById('stop-btn').style.display = 'none';
    document.getElementById('stop-btn').disabled = false;
    document.getElementById('stop-btn').innerHTML = 'â¹ï¸ åœæ­¢æå–';
}

document.getElementById('extract-contacts-btn').addEventListener('click', function() {
    this.disabled = true; this.innerHTML = '<span class="spinner"></span> æå–ä¸­...';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').innerHTML = '<span class="spinner"></span> æå–è”ç³»æ–¹å¼...';
    fetch('/extract_contacts', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `proxy=${encodeURIComponent(document.getElementById('proxy').value)}` });
});

document.getElementById('search-input').addEventListener('input', function() { searchQuery = this.value; currentPage = 1; renderData(); });
document.querySelectorAll('.view-toggle button').forEach(btn => btn.addEventListener('click', function() { document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active')); this.classList.add('active'); currentView = this.dataset.view; renderData(); }));
document.getElementById('send-email-btn').addEventListener('click', function() { const emails = businessData.filter(b => b.emails && b.emails.length).flatMap(b => b.emails).filter(e => e && !e.includes('http')); window.location.href = `/send_email_page?emails=${[...new Set(emails)].join(',')}`; });

socket.on('progress_update', function(d) {
    document.getElementById('progress-bar').style.width = d.progress + '%';
    
    // æ„å»ºè¿›åº¦æ¶ˆæ¯ï¼ŒåŒ…å«æ•°æ®åº“ä¿å­˜ç»Ÿè®¡
    let progressMsg = d.message;
    if (d.progress < 100 && d.progress > 20 && (dbStats.inserted > 0 || dbStats.updated > 0)) {
        progressMsg += ` | å·²å…¥åº“: ${dbStats.inserted}æ–°/${dbStats.updated}æ›´æ–°`;
    }
    document.getElementById('progress-text').innerHTML = d.progress < 100 ? `<span class="spinner"></span> ${progressMsg}` : progressMsg;
    
    if (d.business_data) { businessData.push(d.business_data); saveDataToStorage(); renderData(); }
    if (d.progress === 100 || d.stopping) {
        // æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
        const finalMsg = d.message + (dbStats.inserted > 0 || dbStats.updated > 0 ? ` (å…¥åº“: ${dbStats.inserted}æ–°å¢, ${dbStats.updated}æ›´æ–°)` : '');
        document.getElementById('progress-text').innerHTML = finalMsg;
        
        // é‡ç½®ç»Ÿè®¡
        dbStats = { inserted: 0, updated: 0, skipped: 0, errors: 0 };
        
        if (d.data) { businessData = d.data; currentPage = 1; saveDataToStorage(); renderData(); }
        if (d.csv_file) { 
            document.getElementById('download-btn').href = `/download/${d.csv_file}`; 
            document.getElementById('download-section').classList.add('show');
            localStorage.setItem(DOWNLOAD_KEY, d.csv_file);
        }
        document.getElementById('extract-contacts-btn').style.display = 'block'; 
        document.getElementById('extract-contacts-btn').disabled = false; 
        document.getElementById('extract-contacts-btn').innerHTML = 'ğŸ“§ æå–è”ç³»æ–¹å¼';
        resetExtractionUI();
    }
});

socket.on('contact_update', function(d) {
    document.getElementById('progress-bar').style.width = d.progress + '%';
    document.getElementById('progress-text').innerHTML = d.progress < 100 ? `<span class="spinner"></span> ${d.message}` : d.message;
    if (d.business_data) { const idx = businessData.findIndex(b => b.name === d.business_data.name); if (idx !== -1) { businessData[idx] = d.business_data; saveDataToStorage(); renderData(); }}
    if (d.progress === 100) {
        if (d.data) { businessData = d.data; currentPage = 1; saveDataToStorage(); renderData(); }
        if (d.csv_file) { 
            document.getElementById('download-btn').href = `/download/${d.csv_file}`; 
            document.getElementById('download-section').classList.add('show');
            localStorage.setItem(DOWNLOAD_KEY, d.csv_file);
        }
        document.getElementById('extract-contacts-btn').disabled = false; document.getElementById('extract-contacts-btn').innerHTML = 'ğŸ“§ æå–è”ç³»æ–¹å¼';
    }
});

// æ•°æ®åº“å®æ—¶ä¿å­˜çŠ¶æ€ç›‘å¬
let dbStats = { inserted: 0, updated: 0, skipped: 0, errors: 0 };
socket.on('db_save_status', function(d) {
    if (d.stats) {
        dbStats = d.stats;
    }
    // æ›´æ–°è¿›åº¦æ–‡æœ¬æ˜¾ç¤ºæ•°æ®åº“ä¿å­˜ç»Ÿè®¡
    const statsText = `å·²å…¥åº“: ${dbStats.inserted} æ–°å¢, ${dbStats.updated} æ›´æ–°`;
    const progressText = document.getElementById('progress-text');
    if (progressText && !progressText.innerHTML.includes('å…¥åº“')) {
        // åœ¨ç°æœ‰æ¶ˆæ¯åè¿½åŠ æ•°æ®åº“ç»Ÿè®¡
    }
    
    if (!d.success && d.error) {
        console.warn(`æ•°æ®åº“ä¿å­˜å¤±è´¥ [${d.name}]: ${d.error}`);
    }
});

// é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ®
loadDataFromStorage();
renderData();

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
async function checkTaskStatus() {
    try {
        const response = await fetch('/api/task_status');
        const data = await response.json();
        if (data.status === 'success' && data.is_running) {
            // æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®
            isExtracting = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'flex';
            document.getElementById('progress-text').innerHTML = '<span class="spinner"></span> ä»»åŠ¡è¿›è¡Œä¸­...';
        }
    } catch (e) {
        console.warn('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
    }
}
checkTaskStatus();

</script>