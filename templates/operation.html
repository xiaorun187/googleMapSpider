<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps å•†å®¶æ•°æ®æå–</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 16px; }
        .container { max-width: 1800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 14px 24px; background: rgba(255,255,255,0.98); border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .header h1 { font-size: 20px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .nav-links { display: flex; gap: 10px; }
        .nav-links a { padding: 9px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 9px; font-size: 13px; font-weight: 500; transition: all 0.3s; }
        .nav-links a:hover { transform: translateY(-2px); }
        .main-content { display: grid; grid-template-columns: 340px 1fr; gap: 20px; align-items: stretch; }
        .control-panel { background: rgba(255,255,255,0.98); border-radius: 14px; padding: 20px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .data-panel { background: rgba(255,255,255,0.98); border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .panel-title { font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 18px; display: flex; align-items: center; gap: 9px; }
        .panel-title::before { content: ""; width: 4px; height: 18px; background: linear-gradient(180deg, #667eea, #764ba2); border-radius: 2px; }
    </style>
    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
</head>
<body>
<div class="container">
    <header class="header">
        <h1><span class="logo-icon">ğŸ—ºï¸</span>Google Maps å•†å®¶æ•°æ®æå–</h1>
        <nav class="nav-links"><a href="/history">ğŸ“‹ å†å²è®°å½•</a><a href="/send_email_page">âœ‰ï¸ å‘é€é‚®ä»¶</a></nav>
    </header>
    <div class="main-content">
        <aside class="control-panel" id="control-panel"></aside>
        <main class="data-panel" id="data-panel"></main>
    </div>
</div>
</body>
</html>
<style>
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
    .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 11px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px; transition: all 0.3s; background: #f8fafc; }
    .form-group input:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .checkbox-group { display: flex; align-items: center; gap: 9px; padding: 11px 14px; background: #f8fafc; border-radius: 10px; border: 2px solid #e2e8f0; cursor: pointer; }
    .checkbox-group:hover { border-color: #667eea; }
    .checkbox-group input { width: 16px; height: 16px; accent-color: #667eea; }
    .checkbox-group label { font-size: 13px; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 7px; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .btn:hover:not(:disabled) { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .progress-section { margin-top: 18px; padding-top: 18px; border-top: 1px solid #f1f5f9; }
    .progress-label { font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 8px; text-transform: uppercase; }
    .progress-bar-container { background: #e2e8f0; border-radius: 10px; height: 10px; overflow: hidden; margin-bottom: 10px; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 10px; transition: width 0.4s; }
    .progress-text { font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 7px; }
    .spinner { width: 13px; height: 13px; border: 2px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .data-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-bottom: 1px solid #e2e8f0; border-radius: 14px 14px 0 0; }
    .data-header h2 { font-size: 14px; font-weight: 600; color: #1a1a2e; }
    .data-stats { display: flex; gap: 18px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
    .toolbar { display: flex; gap: 10px; padding: 10px 18px; background: #fafbfc; border-bottom: 1px solid #e2e8f0; }
    .search-box { flex: 1; position: relative; }
    .search-box input { width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; }
    .search-box input:focus { outline: none; border-color: #667eea; }
    .search-box::before { content: "ğŸ”"; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; }
    .view-toggle { display: flex; background: #e2e8f0; border-radius: 6px; padding: 3px; }
    .view-toggle button { padding: 5px 12px; border: none; background: transparent; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .view-toggle button.active { background: white; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .data-list { padding: 14px 18px; flex: 1; display: flex; flex-direction: column; }
    .business-card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px 14px; margin-bottom: 10px; transition: all 0.2s; position: relative; }
    .business-card::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, #667eea, #764ba2); opacity: 0; transition: opacity 0.2s; border-radius: 10px 0 0 10px; }
    .business-card:hover { border-color: #667eea; box-shadow: 0 3px 10px rgba(102,126,234,0.12); }
    .business-card:hover::before { opacity: 1; }
    .business-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .business-name { font-size: 14px; font-weight: 600; color: #1a1a2e; }
    .business-index { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .business-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .info-item { display: flex; align-items: flex-start; gap: 8px; }
    .info-icon { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; background: #f0f4ff; border-radius: 6px; font-size: 12px; flex-shrink: 0; }
    .info-content { flex: 1; min-width: 0; }
    .info-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; }
    .info-value { font-size: 12px; color: #334155; word-break: break-all; line-height: 1.4; }
    .info-value a { color: #667eea; text-decoration: none; }
    .info-value a:hover { text-decoration: underline; }
    .info-value.empty { color: #cbd5e1; font-style: italic; }
    .social-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e2e8f0; }
    .social-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 9px; border-radius: 12px; font-size: 11px; font-weight: 500; text-decoration: none; transition: all 0.2s; }
    .social-tag.facebook { background: #e7f3ff; color: #1877f2; }
    .social-tag.twitter { background: #e8f5fd; color: #1da1f2; }
    .social-tag.instagram { background: #fce4ec; color: #e4405f; }
    .social-tag.linkedin { background: #e8f4f8; color: #0077b5; }
    .social-tag.youtube { background: #ffebee; color: #ff0000; }
    .social-tag.whatsapp { background: #e8f5e9; color: #25d366; }
    .social-tag:hover { transform: scale(1.05); }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th { background: #f8fafc; padding: 12px 14px; text-align: left; font-weight: 600; color: #64748b; border-bottom: 2px solid #e2e8f0; }
    .data-table td { padding: 12px 14px; border-bottom: 1px solid #f1f5f9; color: #334155; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .data-table tr:hover td { background: #f8fafc; }
    .data-table a { color: #667eea; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 4px; padding: 10px 18px; border-top: 1px solid #e2e8f0; }
    .pagination button { padding: 5px 11px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; }
    .pagination button:hover:not(:disabled) { border-color: #667eea; color: #667eea; }
    .pagination button.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: transparent; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-info { font-size: 12px; color: #64748b; margin: 0 8px; }
    .download-section { padding: 10px 18px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-top: 1px solid #d1fae5; display: none; justify-content: space-between; align-items: center; border-radius: 0 0 14px 14px; }
    .download-section.show { display: flex; }
    .download-btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 12px; }
    .download-btn:hover { transform: translateY(-2px); }
    .empty-state { text-align: center; padding: 36px 20px; color: #94a3b8; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .empty-icon { font-size: 36px; margin-bottom: 10px; }
    @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } .business-info { grid-template-columns: 1fr 1fr; } }
</style>
<script>
document.getElementById('control-panel').innerHTML = `
    <h3 class="panel-title">æå–è®¾ç½®</h3>
    <form id="extraction-form">
        <div class="form-group"><label>ğŸ™ï¸ åŸå¸‚åç§°</label><input type="text" id="city" name="city" placeholder="ä¾‹å¦‚: Atlanta, New York, Los Angeles..." required></div>
        <div class="form-group"><label>ğŸ›ï¸ å•†å“/æœåŠ¡åç§°</label><input type="text" id="product" name="product" placeholder="ä¾‹å¦‚: sofa, restaurant, hotel..." required></div>
        <input type="hidden" id="url" name="url">
        <div class="form-group"><label>æå–æ•°é‡</label><input type="number" id="limit" name="limit" value="10" min="1" max="500"></div>
        <div class="form-group"><label>ä»£ç†æœåŠ¡å™¨ (å¯é€‰)</label><input type="text" id="proxy" name="proxy" placeholder="user:pass@host:port"></div>
        <div class="form-group"><div class="checkbox-group"><input type="checkbox" id="remember_position"><label for="remember_position">è®°ä½ä¸Šæ¬¡æå–ä½ç½®</label></div></div>
        <button type="submit" class="btn btn-primary" id="start-btn">ğŸš€ å¼€å§‹æå–</button>
        <button type="button" class="btn btn-success" id="extract-contacts-btn" style="display:none;">ğŸ“§ æå–è”ç³»æ–¹å¼</button>
        <button type="button" class="btn btn-warning" id="send-email-btn">âœ‰ï¸ æ‰¹é‡å‘é€é‚®ä»¶</button>
    </form>
    <div class="progress-section">
        <div class="progress-label">ä»»åŠ¡è¿›åº¦</div>
        <div class="progress-bar-container"><div class="progress-bar" id="progress-bar" style="width:0%"></div></div>
        <p class="progress-text" id="progress-text">ç­‰å¾…å¼€å§‹...</p>
    </div>
`;

document.getElementById('data-panel').innerHTML = `
    <div class="data-header">
        <h2>ğŸ“Š æå–ç»“æœ</h2>
        <div class="data-stats">
            <div class="stat-item"><div class="stat-value" id="total-count">0</div><div class="stat-label">æ€»æ•°</div></div>
            <div class="stat-item"><div class="stat-value" id="email-count">0</div><div class="stat-label">æœ‰é‚®ç®±</div></div>
            <div class="stat-item"><div class="stat-value" id="website-count">0</div><div class="stat-label">æœ‰ç½‘ç«™</div></div>
        </div>
    </div>
    <div class="toolbar">
        <div class="search-box"><input type="text" id="search-input" placeholder="æœç´¢å•†å®¶åç§°ã€ç½‘ç«™ã€é‚®ç®±..."></div>
        <div class="view-toggle"><button class="active" data-view="card">å¡ç‰‡</button><button data-view="table">è¡¨æ ¼</button></div>
    </div>
    <div class="data-list" id="data-list"></div>
    <div class="pagination" id="pagination"></div>
    <div class="download-section" id="download-section">
        <span>âœ… æ•°æ®æå–å®Œæˆ</span>
        <a href="#" class="download-btn" id="download-btn">ğŸ“¥ ä¸‹è½½ Excel</a>
    </div>
`;

const socket = io();
let businessData = [], currentView = 'card', searchQuery = '', currentPage = 1, pageSize = 10;

function updateStats() {
    document.getElementById('total-count').textContent = businessData.length;
    document.getElementById('email-count').textContent = businessData.filter(b => b.emails && b.emails.length > 0).length;
    document.getElementById('website-count').textContent = businessData.filter(b => b.website).length;
}

function formatValue(v) {
    if (!v || (Array.isArray(v) && !v.length)) return '<span class="empty">-</span>';
    if (Array.isArray(v)) return v.map(x => x && x.includes && x.includes('http') ? `<a href="${x}" target="_blank">${x}</a>` : x).join(', ');
    if (v.includes && v.includes('http')) { const s = v.length > 35 ? v.slice(0,35)+'...' : v; return `<a href="${v}" target="_blank" title="${v}">${s}</a>`; }
    return v;
}

function renderCard(b, i) {
    const tags = [];
    if (b.facebook) tags.push(`<a href="${b.facebook}" target="_blank" class="social-tag facebook">ğŸ“˜ Facebook</a>`);
    if (b.twitter) tags.push(`<a href="${b.twitter}" target="_blank" class="social-tag twitter">ğŸ¦ Twitter</a>`);
    if (b.instagram) tags.push(`<a href="${b.instagram}" target="_blank" class="social-tag instagram">ğŸ“· Instagram</a>`);
    if (b.linkedin) tags.push(`<a href="${b.linkedin}" target="_blank" class="social-tag linkedin">ğŸ’¼ LinkedIn</a>`);
    if (b.youtube) tags.push(`<a href="${b.youtube}" target="_blank" class="social-tag youtube">â–¶ï¸ YouTube</a>`);
    if (b.whatsapp) tags.push(`<a href="${b.whatsapp}" target="_blank" class="social-tag whatsapp">ğŸ’¬ WhatsApp</a>`);
    return `<div class="business-card"><div class="business-card-header"><span class="business-name">${b.name||'Unknown'}</span><span class="business-index">#${i+1}</span></div>
        <div class="business-info">
            <div class="info-item"><span class="info-icon">ğŸŒ</span><div class="info-content"><div class="info-label">ç½‘ç«™</div><div class="info-value">${formatValue(b.website)}</div></div></div>
            <div class="info-item"><span class="info-icon">ğŸ“§</span><div class="info-content"><div class="info-label">é‚®ç®±</div><div class="info-value">${formatValue(b.emails)}</div></div></div>
            <div class="info-item"><span class="info-icon">ğŸ“</span><div class="info-content"><div class="info-label">ç”µè¯</div><div class="info-value">${formatValue(b.phones)}</div></div></div>
        </div>${tags.length ? `<div class="social-tags">${tags.join('')}</div>` : ''}</div>`;
}

function renderTable(data, startIdx) {
    return `<table class="data-table"><thead><tr><th>#</th><th>åç§°</th><th>ç½‘ç«™</th><th>é‚®ç®±</th><th>ç”µè¯</th><th>ç¤¾äº¤</th></tr></thead>
        <tbody>${data.map((b,i) => `<tr><td>${startIdx+i+1}</td><td>${b.name||'-'}</td><td>${formatValue(b.website)}</td><td>${formatValue(b.emails)}</td><td>${formatValue(b.phones)}</td>
        <td>${[b.facebook&&'FB',b.instagram&&'IG',b.twitter&&'TW',b.linkedin&&'LI'].filter(Boolean).join(', ')||'-'}</td></tr>`).join('')}</tbody></table>`;
}

function renderPagination(total) {
    const pages = Math.ceil(total / pageSize);
    const pag = document.getElementById('pagination');
    if (pages <= 1) { pag.innerHTML = ''; return; }
    let html = `<button ${currentPage===1?'disabled':''} onclick="goPage(1)">é¦–é¡µ</button>
        <button ${currentPage===1?'disabled':''} onclick="goPage(${currentPage-1})">â€¹</button>`;
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(pages, currentPage + 2); i++) 
        html += `<button class="${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
    html += `<span class="page-info">${currentPage} / ${pages}</span>
        <button ${currentPage===pages?'disabled':''} onclick="goPage(${currentPage+1})">â€º</button>
        <button ${currentPage===pages?'disabled':''} onclick="goPage(${pages})">æœ«é¡µ</button>`;
    pag.innerHTML = html;
}

window.goPage = function(p) { currentPage = p; renderData(); };

function renderData() {
    let filtered = businessData;
    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = businessData.filter(b => (b.name && b.name.toLowerCase().includes(q)) || (b.website && b.website.toLowerCase().includes(q)) || (b.emails && b.emails.some(e => e.toLowerCase().includes(q))));
    }
    const list = document.getElementById('data-list');
    if (!filtered.length) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">${searchQuery?'ğŸ”':'ğŸ“­'}</div><div>${searchQuery?'æœªæ‰¾åˆ°åŒ¹é…ç»“æœ':'æš‚æ— æ•°æ®ï¼Œè¯·è¾“å…¥åŸå¸‚å’Œå•†å“åç§°å¼€å§‹æå–'}</div></div>`;
        document.getElementById('pagination').innerHTML = '';
    } else {
        const start = (currentPage - 1) * pageSize, pageData = filtered.slice(start, start + pageSize);
        list.innerHTML = currentView === 'card' ? pageData.map((b, i) => renderCard(b, start + i)).join('') : renderTable(pageData, start);
        renderPagination(filtered.length);
    }
    updateStats();
}

document.getElementById('extraction-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const city = document.getElementById('city').value.trim();
    const product = document.getElementById('product').value.trim();
    if (!city || !product) { alert('è¯·è¾“å…¥åŸå¸‚åç§°å’Œå•†å“åç§°'); return; }
    
    businessData = []; currentPage = 1; renderData();
    document.getElementById('download-section').classList.remove('show');
    document.getElementById('extract-contacts-btn').style.display = 'none';
    document.getElementById('start-btn').disabled = true;
    document.getElementById('start-btn').innerHTML = '<span class="spinner"></span> æå–ä¸­...';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').innerHTML = `<span class="spinner"></span> æ­£åœ¨å®šä½åŸå¸‚: ${city}ï¼Œæœç´¢: ${product}...`;
    fetch('/start_extraction', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `city=${encodeURIComponent(city)}&product=${encodeURIComponent(product)}&limit=${document.getElementById('limit').value}&proxy=${encodeURIComponent(document.getElementById('proxy').value)}&remember_position=${document.getElementById('remember_position').checked?'on':'off'}`
    }).then(r => r.json()).then(d => { if (d.status !== 'success') { document.getElementById('progress-text').textContent = 'é”™è¯¯: ' + d.message; document.getElementById('start-btn').disabled = false; document.getElementById('start-btn').textContent = 'ğŸš€ å¼€å§‹æå–'; }});
});

document.getElementById('extract-contacts-btn').addEventListener('click', function() {
    this.disabled = true; this.innerHTML = '<span class="spinner"></span> æå–ä¸­...';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').innerHTML = '<span class="spinner"></span> æ­£åœ¨æå–è”ç³»æ–¹å¼...';
    fetch('/extract_contacts', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `proxy=${encodeURIComponent(document.getElementById('proxy').value)}` });
});

document.getElementById('search-input').addEventListener('input', function() { searchQuery = this.value; currentPage = 1; renderData(); });
document.querySelectorAll('.view-toggle button').forEach(btn => btn.addEventListener('click', function() { document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active')); this.classList.add('active'); currentView = this.dataset.view; renderData(); }));
document.getElementById('send-email-btn').addEventListener('click', function() { const emails = businessData.filter(b => b.emails && b.emails.length).flatMap(b => b.emails).filter(e => e && !e.includes('http')); window.location.href = `/send_email_page?emails=${[...new Set(emails)].join(',')}`; });

socket.on('progress_update', function(d) {
    document.getElementById('progress-bar').style.width = d.progress + '%';
    document.getElementById('progress-text').innerHTML = d.progress < 100 ? `<span class="spinner"></span> ${d.message}` : d.message;
    if (d.business_data) { businessData.push(d.business_data); renderData(); }
    if (d.progress === 100) {
        if (d.data) { businessData = d.data; currentPage = 1; renderData(); }
        if (d.csv_file) { document.getElementById('download-btn').href = `/download/${d.csv_file}`; document.getElementById('download-btn').textContent = `ğŸ“¥ ä¸‹è½½ ${d.csv_file}`; document.getElementById('download-section').classList.add('show'); }
        document.getElementById('extract-contacts-btn').style.display = 'block'; document.getElementById('extract-contacts-btn').disabled = false; document.getElementById('extract-contacts-btn').innerHTML = 'ğŸ“§ æå–è”ç³»æ–¹å¼';
        document.getElementById('start-btn').disabled = false; document.getElementById('start-btn').innerHTML = 'ğŸš€ å¼€å§‹æå–';
    }
});

socket.on('contact_update', function(d) {
    document.getElementById('progress-bar').style.width = d.progress + '%';
    document.getElementById('progress-text').innerHTML = d.progress < 100 ? `<span class="spinner"></span> ${d.message}` : d.message;
    if (d.business_data) { const idx = businessData.findIndex(b => b.name === d.business_data.name); if (idx !== -1) { businessData[idx] = d.business_data; renderData(); }}
    if (d.progress === 100) {
        if (d.data) { businessData = d.data; currentPage = 1; renderData(); }
        if (d.csv_file) { document.getElementById('download-btn').href = `/download/${d.csv_file}`; document.getElementById('download-section').classList.add('show'); }
        document.getElementById('extract-contacts-btn').disabled = false; document.getElementById('extract-contacts-btn').innerHTML = 'ğŸ“§ æå–è”ç³»æ–¹å¼';
    }
});

renderData();
</script>
