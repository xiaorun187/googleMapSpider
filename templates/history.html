<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²è®°å½• - Google Maps å•†å®¶æå–</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 16px; }
        .container { max-width: 1800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 14px 24px; background: rgba(255,255,255,0.98); border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .header h1 { font-size: 20px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .nav-links { display: flex; gap: 10px; }
        .nav-links a { padding: 9px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 9px; font-size: 13px; font-weight: 500; transition: all 0.3s; }
        .nav-links a:hover { transform: translateY(-2px); }
        .card { background: rgba(255,255,255,0.98); border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .card-header { padding: 14px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .search-row input { padding: 9px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; width: 180px; }
        .search-row input:focus { outline: none; border-color: #667eea; }
        .search-row select { padding: 9px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: white; }
        .search-row label { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #4a5568; cursor: pointer; }
        .search-row label input { width: 15px; height: 15px; accent-color: #667eea; }
        .btn { padding: 9px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn:hover { transform: translateY(-1px); }
        .column-toggles { display: flex; gap: 14px; flex-wrap: wrap; }
        .column-toggles label { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #64748b; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1><span class="logo-icon">ğŸ“‹</span>å†å²è®°å½•</h1>
        <nav class="nav-links"><a href="/operation">ğŸ” æ•°æ®æå–</a><a href="/send_email_page">âœ‰ï¸ å‘é€é‚®ä»¶</a></nav>
    </header>
    <div class="card">
        <div class="card-header">
            <div class="search-row">
                <input type="text" id="search-query" placeholder="æœç´¢åç§°æˆ–é‚®ç®±...">
                <select id="page-size"><option value="10">10æ¡/é¡µ</option><option value="20">20æ¡/é¡µ</option><option value="50">50æ¡/é¡µ</option></select>
                <label><input type="checkbox" id="show-empty-email"> æ˜¾ç¤ºç©ºé‚®ç®±</label>
                <button class="btn btn-primary" id="search-btn">ğŸ” æœç´¢</button>
            </div>
            <div class="search-row">
                <button class="btn btn-success" id="send-selected-btn">âœ‰ï¸ å‘é€é€‰ä¸­</button>
                <button class="btn btn-warning" id="export-excel-btn">ğŸ“¥ å¯¼å‡ºExcel</button>
            </div>
        </div>
        <div class="card-header" style="padding: 10px 20px; background: #f8fafc;">
            <div class="column-toggles">
                <span style="font-size:11px;color:#94a3b8;margin-right:6px;">æ˜¾ç¤ºåˆ—:</span>
                <label><input type="checkbox" id="toggle-facebook"> Facebook</label>
                <label><input type="checkbox" id="toggle-twitter"> Twitter</label>
                <label><input type="checkbox" id="toggle-instagram"> Instagram</label>
                <label><input type="checkbox" id="toggle-linkedin"> LinkedIn</label>
                <label><input type="checkbox" id="toggle-whatsapp"> WhatsApp</label>
                <label><input type="checkbox" id="toggle-youtube"> YouTube</label>
            </div>
        </div>
        <div style="overflow-x:auto;">
            <table id="history-table"></table>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>
</body>
</html>

<style>
    #history-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    #history-table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 11px 14px; text-align: left; font-weight: 600; white-space: nowrap; }
    #history-table td { padding: 10px 14px; border-bottom: 1px solid #f1f5f9; color: #334155; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #history-table tr:hover td { background: #f8fafc; }
    #history-table a { color: #667eea; text-decoration: none; }
    #history-table a:hover { text-decoration: underline; }
    #history-table input[type="checkbox"] { width: 15px; height: 15px; accent-color: #667eea; }
    .col-hidden { display: none; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 6px; padding: 12px 20px; border-top: 1px solid #e2e8f0; }
    .pagination button { padding: 6px 12px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; }
    .pagination button:hover:not(:disabled) { border-color: #667eea; color: #667eea; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination .page-info { font-size: 12px; color: #64748b; }
</style>
<script>
let currentPage = 1, pageSize = 10, showEmptyEmail = false;
const cols = { facebook: false, twitter: false, instagram: false, linkedin: false, whatsapp: false, youtube: false };

function fmt(v) { return v && v.startsWith('http') ? `<a href="${v}" target="_blank">${v.slice(0,30)}...</a>` : (v || '-'); }
function fmtDate(d) { if (!d) return '-'; const dt = new Date(d); return isNaN(dt) ? '-' : dt.toLocaleString('zh-CN'); }

function render(records, totalPages) {
    const t = document.getElementById('history-table');
    let h = `<thead><tr><th><input type="checkbox" id="select-all"></th><th>ID</th><th>åç§°</th><th>ç½‘ç«™</th><th>é‚®ç®±</th><th>ç”µè¯</th>
        <th class="${cols.facebook?'':'col-hidden'}">Facebook</th><th class="${cols.twitter?'':'col-hidden'}">Twitter</th>
        <th class="${cols.instagram?'':'col-hidden'}">Instagram</th><th class="${cols.linkedin?'':'col-hidden'}">LinkedIn</th>
        <th class="${cols.whatsapp?'':'col-hidden'}">WhatsApp</th><th class="${cols.youtube?'':'col-hidden'}">YouTube</th>
        <th>å‘é€æ¬¡æ•°</th><th>æ›´æ–°æ—¶é—´</th></tr></thead><tbody>`;
    records.forEach(r => {
        h += `<tr><td><input type="checkbox" class="sel" data-email="${r.email||''}"></td><td>${r.id||'-'}</td><td>${r.name||'-'}</td>
            <td>${fmt(r.website)}</td><td>${r.email||'-'}</td><td>${r.phones||'-'}</td>
            <td class="${cols.facebook?'':'col-hidden'}">${fmt(r.facebook)}</td><td class="${cols.twitter?'':'col-hidden'}">${fmt(r.twitter)}</td>
            <td class="${cols.instagram?'':'col-hidden'}">${fmt(r.instagram)}</td><td class="${cols.linkedin?'':'col-hidden'}">${fmt(r.linkedin)}</td>
            <td class="${cols.whatsapp?'':'col-hidden'}">${fmt(r.whatsapp)}</td><td class="${cols.youtube?'':'col-hidden'}">${fmt(r.youtube)}</td>
            <td>${r.send_count||0}</td><td>${fmtDate(r.updated_at)}</td></tr>`;
    });
    h += '</tbody>';
    t.innerHTML = h;
    document.getElementById('select-all').addEventListener('change', e => document.querySelectorAll('.sel').forEach(c => c.checked = e.target.checked));
    
    const pag = document.getElementById('pagination');
    pag.innerHTML = `<button ${currentPage===1?'disabled':''} onclick="go(${currentPage-1})">ä¸Šä¸€é¡µ</button>
        <span class="page-info">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>
        <button ${currentPage>=totalPages?'disabled':''} onclick="go(${currentPage+1})">ä¸‹ä¸€é¡µ</button>`;
}

function load() {
    const q = document.getElementById('search-query').value;
    fetch(`/get_history?page=${currentPage}&size=${pageSize}&query=${encodeURIComponent(q)}&show_empty_email=${showEmptyEmail}`)
        .then(r => r.json()).then(d => render(d.records, d.total_pages));
}

window.go = p => { currentPage = p; load(); };

document.getElementById('search-btn').addEventListener('click', () => { currentPage = 1; load(); });
document.getElementById('page-size').addEventListener('change', e => { pageSize = parseInt(e.target.value); currentPage = 1; load(); });
document.getElementById('show-empty-email').addEventListener('change', e => { showEmptyEmail = e.target.checked; currentPage = 1; load(); });

['facebook','twitter','instagram','linkedin','whatsapp','youtube'].forEach(k => {
    document.getElementById('toggle-'+k).addEventListener('change', e => { cols[k] = e.target.checked; load(); });
});

document.getElementById('send-selected-btn').addEventListener('click', () => {
    const emails = [...document.querySelectorAll('.sel:checked')].map(c => c.dataset.email).filter(e => e && e !== '-');
    if (emails.length) window.location.href = `/send_email_page?emails=${[...new Set(emails)].join(',')}`;
    else alert('è¯·å…ˆé€‰æ‹©é‚®ç®±');
});

document.getElementById('export-excel-btn').addEventListener('click', () => {
    const q = document.getElementById('search-query').value;
    const visibleCols = ['id','name','website','email','phones',...Object.keys(cols).filter(k=>cols[k]),'send_count','updated_at','created_at'];
    fetch(`/export_excel?query=${encodeURIComponent(q)}&show_empty_email=${showEmptyEmail}&columns=${encodeURIComponent(JSON.stringify(visibleCols))}`)
        .then(r => r.blob()).then(b => { const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `history_${new Date().toISOString().slice(0,10)}.xlsx`; a.click(); });
});

load();
</script>
