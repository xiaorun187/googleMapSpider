<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²è®°å½• - Google Maps å•†å®¶æå–</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; padding: 10px; overflow: hidden; }
        .container { max-width: 1800px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 20px; background: rgba(255,255,255,0.98); border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); flex-shrink: 0; }
        .header h1 { font-size: 18px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 8px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .nav-links { display: flex; gap: 8px; }
        .nav-links a { padding: 8px 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 8px; font-size: 12px; font-weight: 500; }
        .card { background: rgba(255,255,255,0.98); border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .card-header { padding: 10px 16px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; flex-shrink: 0; }
        .search-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .search-row input { padding: 7px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; width: 160px; }
        .search-row input:focus { outline: none; border-color: #667eea; }
        .search-row select { padding: 7px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: white; }
        .search-row label { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #4a5568; cursor: pointer; }
        .search-row label input { width: 14px; height: 14px; accent-color: #667eea; }
        .btn { padding: 7px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn:hover { opacity: 0.9; }
        .column-toggles { display: flex; gap: 12px; flex-wrap: wrap; }
        .column-toggles label { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #64748b; cursor: pointer; }
        .table-wrapper { flex: 1; overflow: auto; min-height: 0; }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1><span class="logo-icon">ğŸ“‹</span>å†å²è®°å½•</h1>
        <nav class="nav-links"><a href="/operation">ğŸ” æ•°æ®æå–</a><a href="/send_email_page">âœ‰ï¸ å‘é€é‚®ä»¶</a></nav>
    </header>
    
    <!-- ç¼–è¾‘/æ–°å¢æ¨¡æ€æ¡† -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">ç¼–è¾‘è®°å½•</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="record-form">
                <input type="hidden" id="record-id">
                <div class="form-row"><label>å•†å®¶åç§° *</label><input type="text" id="record-name" required></div>
                <div class="form-row"><label>ç½‘ç«™</label><input type="text" id="record-website" placeholder="https://..."></div>
                <div class="form-row"><label>é‚®ç®±</label><input type="email" id="record-email"></div>
                <div class="form-row"><label>ç”µè¯</label><input type="text" id="record-phones" placeholder="å¤šä¸ªç”µè¯ç”¨é€—å·åˆ†éš”"></div>
                <div class="form-row"><label>åŸå¸‚</label><input type="text" id="record-city"></div>
                <div class="form-row"><label>å•†å“/å…³é”®è¯</label><input type="text" id="record-product"></div>
                <div class="form-row"><label>Facebook</label><input type="text" id="record-facebook"></div>
                <div class="form-row"><label>Twitter</label><input type="text" id="record-twitter"></div>
                <div class="form-row"><label>Instagram</label><input type="text" id="record-instagram"></div>
                <div class="form-row"><label>LinkedIn</label><input type="text" id="record-linkedin"></div>
                <div class="form-row"><label>WhatsApp</label><input type="text" id="record-whatsapp"></div>
                <div class="form-row"><label>YouTube</label><input type="text" id="record-youtube"></div>
            </form>
            <div class="modal-footer">
                <button class="btn" style="background: #e2e8f0; color: #4a5568;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal" id="delete-modal">
        <div class="modal-content confirm-dialog">
            <p id="delete-message">ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ</p>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn" style="background: #e2e8f0; color: #4a5568;" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <div class="search-row">
                <input type="text" id="search-query" placeholder="æœç´¢åç§°æˆ–é‚®ç®±...">
                <label><input type="checkbox" id="show-empty-email" checked> æ˜¾ç¤ºç©ºé‚®ç®±</label>
                <button class="btn btn-primary" id="search-btn">ğŸ” æœç´¢</button>
            </div>
            <div class="search-row">
                <button class="btn btn-primary" id="add-record-btn">â• æ–°å¢è®°å½•</button>
                <button class="btn btn-success" id="send-selected-btn">âœ‰ï¸ å‘é€é€‰ä¸­</button>
                <button class="btn btn-warning" id="export-excel-btn">ğŸ“¥ å¯¼å‡ºExcel</button>
                <button class="btn" id="delete-selected-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
            </div>
        </div>
        <div class="card-header" style="padding: 10px 20px; background: #f8fafc;">
            <div class="column-toggles">
                <span style="font-size:11px;color:#94a3b8;margin-right:6px;">æ˜¾ç¤ºåˆ—:</span>
                <label><input type="checkbox" id="toggle-facebook"> Facebook</label>
                <label><input type="checkbox" id="toggle-twitter"> Twitter</label>
                <label><input type="checkbox" id="toggle-instagram"> Instagram</label>
                <label><input type="checkbox" id="toggle-linkedin"> LinkedIn</label>
                <label><input type="checkbox" id="toggle-whatsapp"> WhatsApp</label>
                <label><input type="checkbox" id="toggle-youtube"> YouTube</label>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="history-table"></table>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>
</body>
</html>

<style>
    #history-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    #history-table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 12px; text-align: left; font-weight: 600; white-space: nowrap; position: sticky; top: 0; z-index: 1; }
    #history-table td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; color: #334155; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #history-table tr:hover td { background: #f8fafc; }
    #history-table a { color: #667eea; text-decoration: none; }
    #history-table a:hover { text-decoration: underline; }
    #history-table input[type="checkbox"] { width: 14px; height: 14px; accent-color: #667eea; }
    .col-hidden { display: none; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 6px; padding: 10px 16px; border-top: 1px solid #e2e8f0; flex-shrink: 0; flex-wrap: wrap; }
    .pagination button { padding: 5px 10px; border: 1px solid #e2e8f0; background: white; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 500; }
    .pagination button:hover:not(:disabled) { border-color: #667eea; color: #667eea; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination button.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: transparent; }
    .pagination .page-info { font-size: 11px; color: #64748b; }
    .pagination .total-info { font-size: 11px; color: #4a5568; font-weight: 500; margin-right: 10px; }
    .pagination .page-size-select { padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 11px; background: white; }
    .pagination .goto-input { width: 50px; padding: 4px 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 11px; text-align: center; }
    .pagination .goto-btn { padding: 4px 8px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; }
    .pagination .goto-btn:hover { opacity: 0.9; }
    
    /* æ“ä½œæŒ‰é’® */
    .action-btn { padding: 4px 8px; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 4px; }
    .action-btn.edit { background: #e0f2fe; color: #0284c7; }
    .action-btn.delete { background: #fee2e2; color: #dc2626; }
    .action-btn:hover { opacity: 0.8; }
    
    /* æ¨¡æ€æ¡† */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 14px; padding: 24px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { font-size: 18px; color: #1a1a2e; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #94a3b8; }
    .modal-close:hover { color: #64748b; }
    .form-row { margin-bottom: 14px; }
    .form-row label { display: block; font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
    .form-row input, .form-row textarea { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; }
    .form-row input:focus, .form-row textarea:focus { outline: none; border-color: #667eea; }
    .form-row textarea { resize: vertical; min-height: 60px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
    
    /* ç¡®è®¤å¯¹è¯æ¡† */
    .confirm-dialog { text-align: center; }
    .confirm-dialog p { margin-bottom: 20px; color: #4a5568; }
</style>
<script>
let currentPage = 1, pageSize = 10, showEmptyEmail = true;
const cols = { facebook: false, twitter: false, instagram: false, linkedin: false, whatsapp: false, youtube: false };

function fmt(v) { return v && v.startsWith('http') ? `<a href="${v}" target="_blank">${v.slice(0,30)}...</a>` : (v || '-'); }
function fmtDate(d) { if (!d) return '-'; const dt = new Date(d); return isNaN(dt) ? '-' : dt.toLocaleString('zh-CN'); }

let pendingDeleteIds = [];

function render(records, totalPages, total) {
    const t = document.getElementById('history-table');
    let h = `<thead><tr><th><input type="checkbox" id="select-all"></th><th>ID</th><th>åç§°</th><th>ç½‘ç«™</th><th>é‚®ç®±</th><th>ç”µè¯</th><th>åŸå¸‚</th><th>å•†å“</th>
        <th class="${cols.facebook?'':'col-hidden'}">Facebook</th><th class="${cols.twitter?'':'col-hidden'}">Twitter</th>
        <th class="${cols.instagram?'':'col-hidden'}">Instagram</th><th class="${cols.linkedin?'':'col-hidden'}">LinkedIn</th>
        <th class="${cols.whatsapp?'':'col-hidden'}">WhatsApp</th><th class="${cols.youtube?'':'col-hidden'}">YouTube</th>
        <th>å‘é€æ¬¡æ•°</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>`;
    
    if (!records || records.length === 0) {
        h += `<tr><td colspan="17" style="text-align: center; padding: 40px; color: #94a3b8;">æš‚æ— æ•°æ®</td></tr>`;
    } else {
        records.forEach(r => {
            h += `<tr data-id="${r.id}"><td><input type="checkbox" class="sel" data-email="${r.email||''}" data-id="${r.id}"></td><td>${r.id||'-'}</td><td>${r.name||'-'}</td>
                <td>${fmt(r.website)}</td><td>${r.email||'-'}</td><td>${r.phones||'-'}</td><td>${r.city||'-'}</td><td>${r.product||'-'}</td>
                <td class="${cols.facebook?'':'col-hidden'}">${fmt(r.facebook)}</td><td class="${cols.twitter?'':'col-hidden'}">${fmt(r.twitter)}</td>
                <td class="${cols.instagram?'':'col-hidden'}">${fmt(r.instagram)}</td><td class="${cols.linkedin?'':'col-hidden'}">${fmt(r.linkedin)}</td>
                <td class="${cols.whatsapp?'':'col-hidden'}">${fmt(r.whatsapp)}</td><td class="${cols.youtube?'':'col-hidden'}">${fmt(r.youtube)}</td>
                <td>${r.send_count||0}</td><td>${fmtDate(r.updated_at)}</td>
                <td><button class="action-btn edit" onclick="editRecord(${r.id})">âœï¸</button><button class="action-btn delete" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸</button></td></tr>`;
        });
    }
    h += '</tbody>';
    t.innerHTML = h;
    
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
        selectAll.addEventListener('change', e => document.querySelectorAll('.sel').forEach(c => c.checked = e.target.checked));
    }
    
    renderPagination(totalPages, total);
}

function renderPagination(totalPages, total) {
    const pag = document.getElementById('pagination');
    const tp = totalPages || 1;
    const totalCount = total || 0;
    
    // ç”Ÿæˆé¡µç æŒ‰é’®
    let pageButtons = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(tp, startPage + maxVisiblePages - 1);
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    if (startPage > 1) {
        pageButtons += `<button onclick="go(1)">1</button>`;
        if (startPage > 2) pageButtons += `<span class="page-info">...</span>`;
    }
    
    for (let i = startPage; i <= endPage; i++) {
        pageButtons += `<button class="${i === currentPage ? 'active' : ''}" onclick="go(${i})">${i}</button>`;
    }
    
    if (endPage < tp) {
        if (endPage < tp - 1) pageButtons += `<span class="page-info">...</span>`;
        pageButtons += `<button onclick="go(${tp})">${tp}</button>`;
    }
    
    pag.innerHTML = `
        <span class="total-info">å…± ${totalCount} æ¡è®°å½•</span>
        <button ${currentPage===1?'disabled':''} onclick="go(1)">é¦–é¡µ</button>
        <button ${currentPage===1?'disabled':''} onclick="go(${currentPage-1})">ä¸Šä¸€é¡µ</button>
        ${pageButtons}
        <button ${currentPage>=tp?'disabled':''} onclick="go(${currentPage+1})">ä¸‹ä¸€é¡µ</button>
        <button ${currentPage>=tp?'disabled':''} onclick="go(${tp})">æœ«é¡µ</button>
        <select class="page-size-select" onchange="changePageSize(this.value)">
            <option value="10" ${pageSize===10?'selected':''}>10æ¡/é¡µ</option>
            <option value="20" ${pageSize===20?'selected':''}>20æ¡/é¡µ</option>
            <option value="50" ${pageSize===50?'selected':''}>50æ¡/é¡µ</option>
            <option value="100" ${pageSize===100?'selected':''}>100æ¡/é¡µ</option>
        </select>
        <span class="page-info">è·³è½¬åˆ°</span>
        <input type="number" class="goto-input" id="goto-page" min="1" max="${tp}" value="${currentPage}">
        <button class="goto-btn" onclick="gotoPage()">GO</button>
    `;
}

window.changePageSize = function(size) {
    pageSize = parseInt(size);
    currentPage = 1;
    load();
};

window.gotoPage = function() {
    const input = document.getElementById('goto-page');
    const page = parseInt(input.value);
    if (page && page >= 1) {
        go(page);
    }
};

// æ¨¡æ€æ¡†æ“ä½œ
function openModal(title = 'ç¼–è¾‘è®°å½•') {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('edit-modal').classList.add('show');
}

function closeModal() {
    document.getElementById('edit-modal').classList.remove('show');
    document.getElementById('record-form').reset();
    document.getElementById('record-id').value = '';
}

function closeDeleteModal() {
    document.getElementById('delete-modal').classList.remove('show');
    pendingDeleteIds = [];
}

// æ–°å¢è®°å½•
document.getElementById('add-record-btn').addEventListener('click', () => {
    document.getElementById('record-id').value = '';
    document.getElementById('record-form').reset();
    openModal('æ–°å¢è®°å½•');
});

// ç¼–è¾‘è®°å½•
async function editRecord(id) {
    try {
        const res = await fetch(`/api/records/${id}`);
        const data = await res.json();
        if (data.status === 'success') {
            const r = data.record;
            document.getElementById('record-id').value = r.id;
            document.getElementById('record-name').value = r.name || '';
            document.getElementById('record-website').value = r.website || '';
            document.getElementById('record-email').value = r.email || '';
            document.getElementById('record-phones').value = r.phones || '';
            document.getElementById('record-city').value = r.city || '';
            document.getElementById('record-product').value = r.product || '';
            document.getElementById('record-facebook').value = r.facebook || '';
            document.getElementById('record-twitter').value = r.twitter || '';
            document.getElementById('record-instagram').value = r.instagram || '';
            document.getElementById('record-linkedin').value = r.linkedin || '';
            document.getElementById('record-whatsapp').value = r.whatsapp || '';
            document.getElementById('record-youtube').value = r.youtube || '';
            openModal('ç¼–è¾‘è®°å½•');
        } else {
            alert('è·å–è®°å½•å¤±è´¥: ' + data.message);
        }
    } catch (e) {
        alert('è·å–è®°å½•å¤±è´¥: ' + e.message);
    }
}

// ä¿å­˜è®°å½•
async function saveRecord() {
    const id = document.getElementById('record-id').value;
    const data = {
        name: document.getElementById('record-name').value,
        website: document.getElementById('record-website').value,
        email: document.getElementById('record-email').value,
        phones: document.getElementById('record-phones').value,
        city: document.getElementById('record-city').value,
        product: document.getElementById('record-product').value,
        facebook: document.getElementById('record-facebook').value,
        twitter: document.getElementById('record-twitter').value,
        instagram: document.getElementById('record-instagram').value,
        linkedin: document.getElementById('record-linkedin').value,
        whatsapp: document.getElementById('record-whatsapp').value,
        youtube: document.getElementById('record-youtube').value
    };
    
    try {
        const url = id ? `/api/records/${id}` : '/api/records';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.status === 'success') {
            closeModal();
            load();
            alert(id ? 'è®°å½•æ›´æ–°æˆåŠŸ' : 'è®°å½•åˆ›å»ºæˆåŠŸ');
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + result.message);
        }
    } catch (e) {
        alert('ä¿å­˜å¤±è´¥: ' + e.message);
    }
}

// åˆ é™¤å•æ¡è®°å½•
function deleteRecord(id) {
    pendingDeleteIds = [id];
    document.getElementById('delete-message').textContent = 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ';
    document.getElementById('delete-modal').classList.add('show');
}

// æ‰¹é‡åˆ é™¤
document.getElementById('delete-selected-btn').addEventListener('click', () => {
    const ids = [...document.querySelectorAll('.sel:checked')].map(c => parseInt(c.dataset.id)).filter(id => !isNaN(id));
    if (ids.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
        return;
    }
    pendingDeleteIds = ids;
    document.getElementById('delete-message').textContent = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•å—ï¼Ÿ`;
    document.getElementById('delete-modal').classList.add('show');
});

// ç¡®è®¤åˆ é™¤
async function confirmDelete() {
    if (pendingDeleteIds.length === 0) return;
    
    try {
        let res;
        if (pendingDeleteIds.length === 1) {
            res = await fetch(`/api/records/${pendingDeleteIds[0]}`, { method: 'DELETE' });
        } else {
            res = await fetch('/api/records/batch-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: pendingDeleteIds })
            });
        }
        const result = await res.json();
        if (result.status === 'success') {
            closeDeleteModal();
            load();
            alert(result.message || 'åˆ é™¤æˆåŠŸ');
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + result.message);
        }
    } catch (e) {
        alert('åˆ é™¤å¤±è´¥: ' + e.message);
    }
}

let totalRecords = 0;

function load() {
    const q = document.getElementById('search-query').value;
    fetch(`/get_history?page=${currentPage}&size=${pageSize}&query=${encodeURIComponent(q)}&show_empty_email=${showEmptyEmail}`)
        .then(r => r.json())
        .then(d => {
            if (d.status === 'error') {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', d.message);
                render([], 1, 0);
            } else {
                totalRecords = d.total || 0;
                render(d.records || [], d.total_pages || 1, totalRecords);
            }
        })
        .catch(e => {
            console.error('è¯·æ±‚å¤±è´¥:', e);
            render([], 1, 0);
        });
}

window.go = p => { currentPage = p; load(); };

document.getElementById('search-btn').addEventListener('click', () => { currentPage = 1; load(); });
document.getElementById('show-empty-email').addEventListener('change', e => { showEmptyEmail = e.target.checked; currentPage = 1; load(); });

['facebook','twitter','instagram','linkedin','whatsapp','youtube'].forEach(k => {
    document.getElementById('toggle-'+k).addEventListener('change', e => { cols[k] = e.target.checked; load(); });
});

document.getElementById('send-selected-btn').addEventListener('click', () => {
    const emails = [...document.querySelectorAll('.sel:checked')]
        .map(c => c.dataset.email)
        .filter(e => e && e.trim() && e !== '-' && e !== 'undefined' && e !== 'null');
    
    if (emails.length) {
        // å»é‡å¹¶ç¼–ç æ¯ä¸ªé‚®ç®±
        const uniqueEmails = [...new Set(emails)];
        const encodedEmails = uniqueEmails.map(e => encodeURIComponent(e.trim())).join(',');
        console.log('å‘é€é‚®ç®±åˆ—è¡¨:', uniqueEmails);
        window.location.href = `/send_email_page?emails=${encodedEmails}`;
    } else {
        alert('è¯·å…ˆé€‰æ‹©æœ‰é‚®ç®±çš„è®°å½•');
    }
});

document.getElementById('export-excel-btn').addEventListener('click', () => {
    const q = document.getElementById('search-query').value;
    const visibleCols = ['id','name','website','email','phones','city','product',...Object.keys(cols).filter(k=>cols[k]),'send_count','updated_at','created_at'];
    fetch(`/export_excel?query=${encodeURIComponent(q)}&show_empty_email=${showEmptyEmail}&columns=${encodeURIComponent(JSON.stringify(visibleCols))}`)
        .then(r => r.blob()).then(b => { const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `history_${new Date().toISOString().slice(0,10)}.xlsx`; a.click(); });
});

load();
</script>
