<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘é€é‚®ä»¶ - Google Maps å•†å®¶æå–</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 16px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 14px 24px; background: rgba(255,255,255,0.98); border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .header h1 { font-size: 20px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .nav-links { display: flex; gap: 10px; }
        .nav-links a { padding: 9px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 9px; font-size: 13px; font-weight: 500; transition: all 0.3s; }
        .nav-links a:hover { transform: translateY(-2px); }
        .main-content { display: grid; grid-template-columns: 340px 1fr; gap: 20px; align-items: stretch; }
        .recipients-panel { background: rgba(255,255,255,0.98); border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .email-panel { background: rgba(255,255,255,0.98); border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .panel-header { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; }
        .panel-title { font-size: 15px; font-weight: 600; color: #1a1a2e; display: flex; align-items: center; gap: 9px; }
        .panel-title::before { content: ""; width: 4px; height: 18px; background: linear-gradient(180deg, #667eea, #764ba2); border-radius: 2px; }
        .panel-body { padding: 16px 20px; flex: 1; display: flex; flex-direction: column; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
        .form-group input, .form-group textarea { width: 100%; padding: 11px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px; transition: all 0.3s; background: #f8fafc; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .checkbox-group { display: flex; align-items: center; gap: 9px; padding: 11px 14px; background: #f8fafc; border-radius: 10px; border: 2px solid #e2e8f0; cursor: pointer; margin-bottom: 14px; }
        .checkbox-group:hover { border-color: #667eea; }
        .checkbox-group input { width: 16px; height: 16px; accent-color: #667eea; }
        .checkbox-group label { font-size: 13px; color: #4a5568; cursor: pointer; }
        .btn { padding: 12px 18px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 7px; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; width: 100%; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; width: 100%; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
    <script src="https://cdn.tiny.cloud/1/kf40zdu58dqe3bhscnrcegr8fyagpuqq07u60szoxfht62pw/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
<div class="container">
    <header class="header">
        <h1><span class="logo-icon">âœ‰ï¸</span>å‘é€é‚®ä»¶</h1>
        <nav class="nav-links"><a href="/operation">ğŸ” æ•°æ®æå–</a><a href="/history">ğŸ“‹ å†å²è®°å½•</a></nav>
    </header>
    <div class="main-content">
        <aside class="recipients-panel">
            <div class="panel-header"><h3 class="panel-title">æ”¶ä»¶äººåˆ—è¡¨</h3></div>
            <div class="panel-body">
                <div class="recipients-stats" id="recipients-stats"></div>
                <div class="recipients-list" id="recipients-list"></div>
                <div class="add-email-section">
                    <div class="form-group">
                        <label>æ·»åŠ æ”¶ä»¶äºº</label>
                        <textarea id="add-email-input" rows="3" placeholder="è¾“å…¥é‚®ç®±åœ°å€ï¼Œæ”¯æŒç©ºæ ¼ã€é€—å·ã€åˆ†å·æˆ–æ¢è¡Œåˆ†éš”"></textarea>
                    </div>
                    <button class="btn btn-success" id="add-email-btn">â• æ·»åŠ é‚®ç®±</button>
                </div>
            </div>
        </aside>
        <main class="email-panel">
            <div class="panel-header"><h3 class="panel-title">é‚®ä»¶å†…å®¹</h3></div>
            <div class="panel-body">
                <div class="form-group">
                    <label>é‚®ä»¶ä¸»é¢˜</label>
                    <input type="text" id="subject" value="Google Maps Extraction Results">
                </div>
                <div class="form-group" style="flex:1;display:flex;flex-direction:column;">
                    <label>é‚®ä»¶æ­£æ–‡</label>
                    <textarea id="email-body" style="flex:1;min-height:280px;"></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="attach-file" checked>
                    <label for="attach-file">é™„åŠ  CSV æ–‡ä»¶</label>
                </div>
                <button class="btn btn-primary" id="send-email">ğŸš€ å‘é€é‚®ä»¶</button>
                <div class="progress-section" id="progress-section"></div>
            </div>
        </main>
    </div>
</div>
</body>
</html>

<style>
    .recipients-stats { display: flex; gap: 14px; margin-bottom: 14px; padding: 12px; background: linear-gradient(135deg, #f0f4ff, #f5f3ff); border-radius: 10px; }
    .stat-item { text-align: center; flex: 1; }
    .stat-value { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 10px; color: #64748b; text-transform: uppercase; }
    .recipients-list { flex: 1; overflow-y: auto; max-height: 280px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 14px; }
    .recipient-item { display: flex; align-items: center; justify-content: space-between; padding: 9px 12px; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
    .recipient-item:last-child { border-bottom: none; }
    .recipient-item:hover { background: #f8fafc; }
    .recipient-email { font-size: 12px; color: #334155; display: flex; align-items: center; gap: 7px; }
    .recipient-email::before { content: "ğŸ“§"; font-size: 11px; }
    .recipient-actions { display: flex; gap: 5px; }
    .recipient-actions button { padding: 4px 9px; border: none; border-radius: 5px; font-size: 11px; cursor: pointer; transition: all 0.2s; }
    .recipient-actions .edit-btn { background: #fef3c7; color: #d97706; }
    .recipient-actions .delete-btn { background: #fee2e2; color: #dc2626; }
    .recipient-actions button:hover { transform: scale(1.05); }
    .empty-recipients { text-align: center; padding: 36px 16px; color: #94a3b8; }
    .empty-recipients .empty-icon { font-size: 36px; margin-bottom: 10px; }
    .add-email-section { margin-top: auto; padding-top: 14px; border-top: 1px solid #e2e8f0; }
    .progress-section { margin-top: 14px; padding: 14px; background: #f8fafc; border-radius: 10px; display: none; }
    .progress-section.show { display: block; }
    .progress-bar-container { background: #e2e8f0; border-radius: 10px; height: 10px; overflow: hidden; margin-bottom: 10px; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 10px; transition: width 0.4s; width: 0%; }
    .progress-text { font-size: 12px; color: #64748b; text-align: center; }
    .edit-input { width: 100%; padding: 5px 9px; border: 2px solid #667eea; border-radius: 5px; font-size: 12px; }
    .spinner { width: 13px; height: 13px; border: 2px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 1000px) { .main-content { grid-template-columns: 1fr; } }
</style>
<script>
const urlParams = new URLSearchParams(window.location.search);
const csvFile = urlParams.get('file') || 'No file generated';
let emails = decodeURIComponent(urlParams.get('emails') || '').split(',').filter(e => e && e.trim());

function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

function renderStats() {
    document.getElementById('recipients-stats').innerHTML = `
        <div class="stat-item"><div class="stat-value">${emails.length}</div><div class="stat-label">æ”¶ä»¶äºº</div></div>
        <div class="stat-item"><div class="stat-value">${emails.filter(isValidEmail).length}</div><div class="stat-label">æœ‰æ•ˆé‚®ç®±</div></div>
    `;
}

function renderRecipients() {
    const list = document.getElementById('recipients-list');
    if (!emails.length) {
        list.innerHTML = '<div class="empty-recipients"><div class="empty-icon">ğŸ“­</div><div>æš‚æ— æ”¶ä»¶äºº</div></div>';
    } else {
        list.innerHTML = emails.map((email, i) => `
            <div class="recipient-item" data-index="${i}">
                <span class="recipient-email">${email}</span>
                <div class="recipient-actions">
                    <button class="edit-btn" onclick="editEmail(${i})">ç¼–è¾‘</button>
                    <button class="delete-btn" onclick="deleteEmail(${i})">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    }
    renderStats();
}

window.deleteEmail = function(i) { emails.splice(i, 1); renderRecipients(); };

window.editEmail = function(i) {
    const item = document.querySelector(`.recipient-item[data-index="${i}"]`);
    const emailSpan = item.querySelector('.recipient-email');
    const current = emails[i];
    emailSpan.innerHTML = `<input type="email" class="edit-input" value="${current}" onkeydown="if(event.key==='Enter')saveEmail(${i},this.value)">`;
    emailSpan.querySelector('input').focus();
    item.querySelector('.edit-btn').textContent = 'ä¿å­˜';
    item.querySelector('.edit-btn').onclick = () => saveEmail(i, item.querySelector('.edit-input').value);
};

window.saveEmail = function(i, val) {
    val = val.trim();
    if (val && isValidEmail(val)) { emails[i] = val; renderRecipients(); }
    else { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€'); }
};

document.getElementById('add-email-btn').addEventListener('click', function() {
    const input = document.getElementById('add-email-input').value.trim();
    if (!input) { alert('è¯·è¾“å…¥é‚®ç®±åœ°å€'); return; }
    const newEmails = input.split(/[\s,;]+|\r\n|\n|\r/).map(e => e.trim()).filter(e => e);
    let added = 0, invalid = [], dup = [];
    newEmails.forEach(e => {
        if (!isValidEmail(e)) invalid.push(e);
        else if (emails.includes(e)) dup.push(e);
        else { emails.push(e); added++; }
    });
    renderRecipients();
    document.getElementById('add-email-input').value = '';
    let msg = added ? `æˆåŠŸæ·»åŠ  ${added} ä¸ªé‚®ç®±ã€‚` : '';
    if (invalid.length) msg += ` æ— æ•ˆ: ${invalid.join(', ')}`;
    if (dup.length) msg += ` é‡å¤: ${dup.join(', ')}`;
    if (msg) alert(msg);
});

tinymce.init({
    selector: '#email-body',
    height: 320,
    menubar: true,
    plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table emoticons wordcount',
    toolbar: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | forecolor backcolor | link image | code',
    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 14px; }',
    init_instance_callback: function(editor) {
        const cached = localStorage.getItem('emailBodyCache');
        editor.setContent(cached || `<p>æ‚¨å¥½ï¼Œ</p><p>è¿™æ˜¯ Google Maps å•†å®¶æ•°æ®æå–ç»“æœï¼š</p><ul><li>æå–æ—¶é—´: ${new Date().toLocaleString()}</li><li>æ–‡ä»¶: ${csvFile}</li></ul><p>è¯·æŸ¥çœ‹é™„ä»¶æˆ–ä¸‹è½½é“¾æ¥ã€‚</p><p>æ­¤è‡´</p>`);
        editor.on('Change', () => localStorage.setItem('emailBodyCache', editor.getContent()));
    }
});

const subjectInput = document.getElementById('subject');
const cachedSubject = localStorage.getItem('emailSubjectCache');
if (cachedSubject) subjectInput.value = cachedSubject;
subjectInput.addEventListener('input', function() { localStorage.setItem('emailSubjectCache', this.value); });

document.getElementById('send-email').addEventListener('click', async function() {
    if (!emails.length) { alert('è¯·æ·»åŠ æ”¶ä»¶äºº'); return; }
    const subject = document.getElementById('subject').value;
    const body = tinymce.get('email-body').getContent();
    const attachFile = document.getElementById('attach-file').checked;
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> å‘é€ä¸­...';
    
    const progress = document.getElementById('progress-section');
    progress.classList.add('show');
    progress.innerHTML = `<div class="progress-bar-container"><div class="progress-bar" id="prog-bar"></div></div><div class="progress-text" id="prog-text">å‡†å¤‡å‘é€...</div>`;
    
    let success = 0;
    for (let i = 0; i < emails.length; i++) {
        const pct = Math.round((i / emails.length) * 100);
        document.getElementById('prog-bar').style.width = pct + '%';
        document.getElementById('prog-text').textContent = `æ­£åœ¨å‘é€ ${i+1}/${emails.length} åˆ° ${emails[i]}...`;
        try {
            const res = await fetch('/send_email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recipient: emails[i], subject, body, attach_file: attachFile ? csvFile : null })
            });
            const data = await res.json();
            if (data.status === 'success') success++;
        } catch (e) { console.error(e); }
        await new Promise(r => setTimeout(r, 1000));
    }
    document.getElementById('prog-bar').style.width = '100%';
    document.getElementById('prog-text').textContent = `å‘é€å®Œæˆï¼æˆåŠŸ ${success}/${emails.length}`;
    btn.disabled = false;
    btn.innerHTML = 'ğŸš€ å‘é€é‚®ä»¶';
});

renderRecipients();
</script>
