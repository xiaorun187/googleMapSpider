# Implementation Plan

- [x] 1. Update database schema and initialization
  - [x] 1.1 Add unique_id field and update table schema in db.py
    - Add `unique_id TEXT` column to business_records table
    - Add `generate_unique_id()` function using UUID
    - Remove UNIQUE constraint from email field
    - Create UNIQUE index on unique_id field
    - Create composite UNIQUE index on (name, website)
    - _Requirements: 2.1, 3.1, 3.2, 3.3_
  - [x] 1.2 Write property test for unique_id generation
    - **Property 4: Unique ID Generation**
    - **Validates: Requirements 2.1, 2.2**
  - [x] 1.3 Add database migration logic for existing data
    - Generate unique_id for existing records without one
    - Handle potential (name, website) duplicates in existing data
    - _Requirements: 2.1_

- [x] 2. Implement validation and duplicate detection in db.py
  - [x] 2.1 Create ValidationResult dataclass and validation functions
    - Add `ValidationResult` dataclass with is_valid, error_message, existing_record
    - Implement `validate_uniqueness(name, website, exclude_id)` function
    - Implement `check_duplicate_exists(name, website)` function
    - _Requirements: 4.1, 4.2_
  - [x] 2.2 Write property test for duplicate detection
    - **Property 1: Duplicate Detection by Name and Website**
    - **Validates: Requirements 1.1**
  - [x] 2.3 Write property test for distinct records with different name
    - **Property 2: Distinct Records with Different Name**
    - **Validates: Requirements 1.2, 1.4**
  - [x] 2.4 Write property test for distinct records with different website
    - **Property 3: Distinct Records with Different Website**
    - **Validates: Requirements 1.3, 1.4**

- [x] 3. Update data insertion functions in db.py
  - [x] 3.1 Refactor save_business_data_to_db() function
    - Add unique_id generation before insert
    - Replace INSERT OR REPLACE with validation-first approach
    - Add proper error handling for duplicate detection
    - Return validation errors with descriptive messages
    - _Requirements: 1.1, 1.2, 1.3, 4.1, 4.2, 4.3_
  - [x] 3.2 Refactor save_business_data_batch() function
    - Add unique_id generation for batch inserts
    - Implement pre-validation for all records in batch
    - Handle partial failures gracefully
    - _Requirements: 1.1, 4.3_
  - [x] 3.3 Write property test for error handling
    - **Property 6: Duplicate Insertion Error Handling**
    - **Validates: Requirements 4.1, 4.2, 4.3**

- [x] 4. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 5. Update BusinessRecord model
  - [x] 5.1 Add unique_id field to BusinessRecord dataclass
    - Add `unique_id: Optional[str] = None` field
    - Update `to_dict()` and `from_dict()` methods
    - Update `to_json()` and `from_json()` methods
    - _Requirements: 2.3_
  - [x] 5.2 Update equality and hash methods
    - Change `__eq__` to compare by (name, website) instead of email
    - Change `__hash__` to hash (name, website) instead of email
    - _Requirements: 1.1, 1.2, 1.3_
  - [x] 5.3 Write property test for BusinessRecord round-trip with unique_id
    - **Property 7: BusinessRecord Round-Trip with Unique ID**
    - **Validates: Requirements 2.3**

- [x] 6. Update DataDeduplicator component
  - [x] 6.1 Refactor check_duplicate() method
    - Change duplicate detection from email-based to (name, website)-based
    - Update method signature and documentation
    - _Requirements: 1.1_
  - [x] 6.2 Update deduplicate_list() method
    - Change deduplication key from email to (name, website)
    - Update merge logic for records with same (name, website)
    - _Requirements: 1.1, 1.2, 1.3_
  - [x] 6.3 Add is_duplicate_by_name_website() method
    - New helper method for explicit (name, website) duplicate check
    - _Requirements: 1.1_

- [x] 7. Update query functions in db.py
  - [x] 7.1 Update get_history_records() to include unique_id
    - Add unique_id to SELECT columns
    - Ensure unique_id is returned in query results
    - _Requirements: 2.3_
  - [x] 7.2 Write property test for unique_id in query results
    - **Property 5: Unique ID Presence in Query Results**
    - **Validates: Requirements 2.3**

- [x] 8. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
